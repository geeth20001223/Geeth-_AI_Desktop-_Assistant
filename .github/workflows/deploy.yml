name: Deploy to Environment

on:
  push:
    branches:
      - dev
      - staging
      - main

permissions:
  contents: read
  security-events: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v3

      # Step 2: Setup Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # Step 3: Install Dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Step 4: Setup SSH Private Key
      - name: Setup SSH Private Key
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > key.pem
          chmod 600 key.pem

      # Step 5: Deploy to Correct Environment
      - name: Deploy to Environment
        env:
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          echo "üì¶ Deploying from branch: $BRANCH_NAME"

          if [ "$BRANCH_NAME" = "dev" ]; then
            echo "üöÄ Deploying to DEV server..."
            ssh -o StrictHostKeyChecking=no -i key.pem azureuser@20.195.40.50 \
              'cd /home/azureuser/Geeth-_AI_Desktop-_Assistant && git pull origin dev && systemctl restart geeth-assistant.service'

          elif [ "$BRANCH_NAME" = "staging" ]; then
            echo "üöÄ Deploying to STAGING server..."
            ssh -o StrictHostKeyChecking=no -i key.pem azureuser@20.195.40.50 \
              'cd /home/azureuser/Geeth-_AI_Desktop-_Assistant && git pull origin staging && systemctl restart geeth-assistant.service'

          elif [ "$BRANCH_NAME" = "main" ]; then
            echo "üöÄ Deploying to PRODUCTION server..."
            ssh -o StrictHostKeyChecking=no -i key.pem azureuser@20.195.40.50 \
              'cd /home/azureuser/Geeth-_AI_Desktop-_Assistant && git pull origin main && systemctl restart geeth-assistant.service'

          else
            echo "‚ùå Unknown branch: $BRANCH_NAME"
            exit 1

  security-scan:
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: python, javascript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

      - name: Run Snyk SCA
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          npm install -g snyk
          snyk auth $SNYK_TOKEN
          snyk test --all-projects --fail-on=all
